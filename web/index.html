<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <link rel="icon" href="favicon.png" />
    <link rel="stylesheet" type="text/css" href="css/movie.css" />
    <script type="text/javascript" src="js/jquery.min.js" ></script>
</head>
<body>
    <h1>二輪電影排程器</h1>

    <select id="theaters" onchange="selectTheater()">
        <option disabled selected value> -- 選擇戲院 -- </option>
        <!-- init menu from movie.json -->
    </select>

    <h2 id="title"></h2>

    <section id="movies"></section>
    
    <input id="sched_btn" type="button" value="排程！" onclick="scheduling('infos')" >
    <section id="scheds"></section>
</body>
<script>


function strToMinutes(str)
{
    var tokens = (str.indexOf(':') >= 0)?
        str.split(':'):
        str.split('：');

    if(tokens.length != 2)
        return 0;

    var h = Number(tokens[0]);
    var m = Number(tokens[1]);
    return  h * 60 + m;
}

function padZero(num){
    num = String(num);
    var len = 2;
    if(len > num.length)
        num = (len - num.length) * '0' + num;
    return num;
}

function minutesToStr(min)
{
    h = Math.floor(min/60);
    m = min - h * 60;
    return padZero(h) + ":" + padZero(m);
}

//Period ===========================
function Period(begin, end){
    this.begin = begin;
    this.end = end;

    //properties
    this.duration = this.end - this.begin;
}

Period.prototype.toString = function(){
    return minutesToStr(this.begin) + "~" + minutesToStr(this.end);
}

Period.prototype.contains = function(rhs){
    return this.begin <= rhs.begin && this.end >= rhs.end;
}

// Movie ===========================
function Movie(name, period){
    this.name = name;
    this.period = period;

    //export period properties
    this.begin = this.period.begin;
    this.end = this.period.end;
    this.duration = this.period.duration;
}

Movie.prototype.toString = function(){
    return this.name + "[" + this.period.toString() + "]";
}


// Movie info ======================
function MovieInfo(name){
    this.name = name;
    this.periods = [];
}

MovieInfo.prototype.addShowtime = function(period){
    this.periods.push(period)
}

MovieInfo.prototype.genMovies = function()
{
    var movies = [];
    for(var i = 0; i < this.periods.length; ++i){
        var period = this.periods[i];
        var movie = new Movie(this.name, period);
        movies.push(movie);
    }
    return movies;
}

// Sched ============================
function Sched(movie){
    this.movies = [];
    if(movie != null)
        this.movies.push(movie);

    Object.defineProperty(this, "begin", {
        get: function(){
            if(this.movies.length > 0)
                return this.movies[0].begin;
            return null;
        },
        enumerable: true
    });

    Object.defineProperty(this, "end", {
        get: function(){
            if(this.movies.length > 0)
                return this.movies[this.movies.length - 1].end;
            return null;
        },
        enumerable: true
    });

    Object.defineProperty(this, "duration", {
        get: function(){
            if(this.begin != null && this.end != null)
                return this.end - this.begin;
            return 0;
        },
        enumerable: true
    });
}

Sched.prototype.put = function(movie)
{
    this.movies.unshift(movie);
}

Sched.prototype.toString = function(){
    var txts = [];
    for(var i = 0; i < this.movies.length; ++i){
        txts.push(this.movies[i].toString());
    }
    return "(" + txts.join() + ")"
}

// Algo ============================
function putMovieToScheds(scheds, movie)
{
    for(var i = 0; i < scheds.length; ++i)
        scheds[i].put(movie);
}

function excludeMovies(movies, name)
{
    var result = [];
    for(var i = 0; i < movies.length; ++i){
        var movie = movies[i];
        if(movie.name != name)
            result.push(movie);
    }
    return result;
}

function pickMovies(period, movies){
    if(movies.length == 0)
        return [new Sched()];  //empty schedule

    // not pick the first
    var sub_movies = movies.slice(1);
    var scheds = pickMovies(period, sub_movies);

    // Or pick the first movie
    var target = movies[0];
    if(period.contains(target.period)){
        //pick the rest
        var sub_movies = excludeMovies(movies, target.name);
        var sub_period = new Period(target.period.end, period.end);
        var sub_scheds = pickMovies(sub_period, sub_movies);
        putMovieToScheds(sub_scheds, target);
        scheds = scheds.concat(sub_scheds);
    }

    return scheds;
}


//load page ========================
var Props = {};

$(document).ready(function(){
    //loadMovieInfo();
    $('#sched_btn').hide();
});

function selectTheater()
{
    //var name = $('#theaters option:selected').text();
    //alert('selecct ' + name);

    //rest UI
    $('#movies').html('');
    $('#scheds').html('');
    $('#sched_btn').hide();

    var link = $('#theaters').val()
    loadMovieInfo(link);
}

// Parse  Movie info =========================================================
function loadMovieInfo(link)
{
    $.ajax({
        //crossOrigin: true,
        url: link,
        dataType: "html",
        success: function(data){
            //console.log(data);
            //var html = $.parseHTML(data)

            var theater = $(data).find("h2").html();
            var date = $(data).find("h3").html();
            $('#title').html(theater + " - " + date);

            var movies = $(data).find("#theaterShowtimeTable");
            console.log("There are " + movies.length + " movies");

            //collect movie info
            var infos = []
            $.each(movies, function(idx, movie){
                var info = collectMovieInfo(movie);
                infos.push(info);
            });

            //set to global
            Props["infos"] = infos;

            //show
            displayMovieInfos(infos)
            $('#sched_btn').show();

            //@@! programatic trigger
            //scheduling("infos");
        },
        erro: function(){
            alert('download error');
        }
    });
}

function collectMovieInfo(elem)
{
    var a_title = $(elem).find('.filmTitle>a'); //should be <a> ref to movie title
    a_title.attr('target', '_blank');
    a_title.attr('href', "http://www.atmovies.com.tw" + a_title.attr('href'));
    var name = a_title[0].outerHTML;   //innerHTML is just title name without link

    //length (min)
    var img = elem.getElementsByTagName('IMG')[1].parentNode.innerHTML;
    var pos = img.lastIndexOf('：') + 1;
    var len = Number(img.substr(pos, img.length - pos - 1));

    //info
    var info = new MovieInfo(name);

    //showtimes
    var showtimes = elem.getElementsByClassName("filmVersion")[0].parentNode;
    for(var i = 1; i < showtimes.children.length -1; ++i){
        var showtime = showtimes.children[i];
        var begin = strToMinutes(showtime.innerHTML);
        if(begin < 6*60)  //is next day
            begin += 24*60
        
        var period = new Period(begin, begin + len);
        info.addShowtime(period);
    }

    return info;
}

// Show  Movie info =========================================================
function displayMovieInfos(infos)
{
    var htmls = "";
    for(var i = 0; i < infos.length; ++i){
        var info = infos[i];
        var html = genMovieInfoHtml(i, info);
        htmls += html + "\n";
    }

    $('#movies').html(htmls);
}

function genMovieInfoHtml(id, info)
{
    var html = "";
    //@@! for dev
    /*
    if(id == 0 || id == 2)
        html += "<input type='checkbox' checked id='m" + id + "'>";
    else
        html += "<input type='checkbox' id='m" + id + "'>";
    */
    html += "<input type='checkbox' id='m" + id + "'>";
    html += info.name;
    html += "<span class='periods'>";
    for(var i = 0; i < info.periods.length; ++i){
        var period = info.periods[i];
        var pid = "m" + id + "p" + i;
        html += "<input type='checkbox' checked id='" + pid + "'>" + period.toString() + " ";
    }
    html += "</span>";

    return "<div>" + html + "</div>";
}

// Collect Movies =========================================================

function scheduling(prop_name)
{
    //get slected movie info
    var infos = Props[prop_name];
    infos = collectCheckedInfos(infos);
    console.log(infos.length + " movies is selected");

    //all seletec movies
    var movies = genMovies(infos);
    if(!movies.length){
        alert('No Movie Selected');
        return;
    }

    var period = new Period(movies[0].begin, getLastEndMovie(movies).end);
    console.log(period.toString());

    var scheds = pickMovies(period, movies);
    scheds.sort(function(s1, s2){
        return s1.duration - s2.duration;
    });
    
    displayScheds(scheds, infos.length);
}

function collectCheckedInfos(infos)
{
    var ck_infos = [];

    for(var i = 0; i < infos.length; ++i){
        if (!$("#m" + i).prop("checked"))
            continue;

        var info = infos[i];
        var ck_info = new MovieInfo(info.name);

        //collect periods
        for(var j = 0; j < info.periods.length; ++j){
            if (!$("#m" + i + "p" + j).prop("checked"))
                continue;
            var period = info.periods[j];
            ck_info.addShowtime(period);
        }

        //collect info
        if(ck_info.periods.length != 0)
            ck_infos.push(ck_info);
    }

    return ck_infos;
}

function genMovies(infos)
{
    var movies = [];
    for(var i = 0; i < infos.length; ++i){
        var info = infos[i];
        movies = movies.concat(info.genMovies());
    }

    //sort
    movies.sort(function(m1, m2){
        return m1.period.begin - m2.period.begin;
    });

    return movies;
}

function getLastEndMovie(movies)
{
    var m = null;
    for(var i = 0; i < movies.length; ++i){
        if(m == null || m.end < movies[i].end)
            m = movies[i];
    }
    return m;
}

function displayScheds(scheds, min_num)
{

    var scale = 95;
    var scale_ =  100 - scale;

    var period = getSchedsPeriod(scheds);
    console.log("scheds period: " + period.toString());

    var html = "";
    var sn = 1;
    for(var i = 0; i < scheds.length; ++i){
        var sched = scheds[i];
        if(sched.movies.length < min_num)
            continue;

        html += "<div class='sched'>";
        html += "<div class='sched-sn' style='width:" + scale_ + "%' >" + sn + "</div>";
        html += "<div class='movies' style='width:" + scale + "%' >";
        for(var j = 0; j < sched.movies.length; ++j){
            var movie = sched.movies[j];
            var left = scale_ + scale * (movie.begin - period.begin) / period.duration;
            var width = scale * movie.duration / period.duration;
            html += "<div class='movie movie" + getInfoIdx(movie) + "' style='left:" + left + "%;width:" + width +"%' >"
                + movie.name + "<br>" + movie.period.toString() + "</div>";
        }
        html += "</div></div>";

        ++sn;
    }

    //check if any schedule shown
    if(sn == 1){
        alert('No schedule');
        return;
    }

    $('#scheds').html(html);
}

function getSchedsPeriod(scheds)
{
    if(scheds.length == 0)
        return null;

    var begin = null;
    var end = null;
    for(var i = 0; i < scheds.length; ++i){
        var sched = scheds[i];
        if(begin == null || begin > sched.begin) begin = sched.begin;
        if(end   == null || end   < sched.end)   end   = sched.end;
    }

    return new Period(begin, end);
}

function getInfoIdx(movie)
{
    var infos = Props["infos"];
    for(var i = 0; i < infos.length; ++i){
        if(infos[i].name == movie.name)
            return i;
    }
    return -1;
}

// Init theaters menu
$(document).ready(function(){
    $.getJSON('theaters.json', function(theaters){
        for(var i = 0; i < theaters.length; ++i){
            var th = theaters[i];
            $("#theaters").append('<option value="' + th.local + '">' + th.title + '</option>');
        }
    });
});

</script>
</html>

